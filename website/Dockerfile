# ğŸ³ EdGoing Next.js Docker éƒ¨ç½²æ–‡ä»¶
# æ”¯æŒ x86_64 (AMD64) æ¶æ„çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

# ==========================================
# é˜¶æ®µ 1: ä¾èµ–å®‰è£…é˜¶æ®µ
# ==========================================
FROM node:20-slim AS deps
# å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*
WORKDIR /app

# å¤åˆ¶åŒ…ç®¡ç†æ–‡ä»¶
COPY package*.json ./
# å®‰è£…ä¾èµ–ï¼ˆä½¿ç”¨ npm install è€Œä¸æ˜¯ npm ci æ¥å¤„ç†ç‰ˆæœ¬å†²çªï¼‰
RUN npm install --legacy-peer-deps

# ==========================================
# é˜¶æ®µ 2: æ„å»ºé˜¶æ®µ
# ==========================================
FROM node:20-slim AS builder
# å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*
WORKDIR /app

# å¤åˆ¶ä¾èµ–
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NEXT_TELEMETRY_DISABLED=1
ENV NODE_ENV=production
ENV SKIP_ENV_VALIDATION=true

# ç”Ÿæˆ Prisma å®¢æˆ·ç«¯ï¼ˆä½¿ç”¨é¢„å®‰è£…çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰
RUN npx prisma generate --generator client

# æ„å»ºåº”ç”¨
RUN npm run build

# ==========================================
# é˜¶æ®µ 3: è¿è¡Œé˜¶æ®µ
# ==========================================
FROM node:20-slim AS runner
# å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*
WORKDIR /app

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1

# åˆ›å»ºé root ç”¨æˆ·
RUN groupadd --system --gid 1001 nodejs
RUN useradd --system --uid 1001 --gid nodejs nextjs

# å¤åˆ¶å¿…è¦çš„æ–‡ä»¶
COPY --from=builder /app/public ./public

# å¤åˆ¶ standalone æ„å»ºè¾“å‡º
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# å¤åˆ¶ Prisma ç›¸å…³æ–‡ä»¶
COPY --from=builder /app/prisma ./prisma

# åˆ›å»ºæ•°æ®åº“ç›®å½•å’Œå¯åŠ¨è„šæœ¬
RUN mkdir -p /app/data

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash\n\
echo "ğŸ”§ ç”Ÿæˆ Prisma å®¢æˆ·ç«¯..."\n\
npx prisma generate\n\
echo "âœ… Prisma å®¢æˆ·ç«¯ç”Ÿæˆå®Œæˆ"\n\
echo "ğŸš€ å¯åŠ¨åº”ç”¨..."\n\
exec node server.js' > /app/start.sh && chmod +x /app/start.sh

# è®¾ç½®æ–‡ä»¶æƒé™
RUN chown -R nextjs:nodejs /app

USER nextjs

# æš´éœ²ç«¯å£
EXPOSE 3000

ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# å¯åŠ¨åº”ç”¨
CMD ["/app/start.sh"]
